\documentclass[11pt,]{article}
\usepackage[left=1in,top=1in,right=1in,bottom=1in]{geometry}
\newcommand*{\authorfont}{\fontfamily{phv}\selectfont}
\usepackage[]{mathpazo}


  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}




\usepackage{abstract}
\renewcommand{\abstractname}{}    % clear the title
\renewcommand{\absnamepos}{empty} % originally center

\renewenvironment{abstract}
 {{%
    \setlength{\leftmargin}{0mm}
    \setlength{\rightmargin}{\leftmargin}%
  }%
  \relax}
 {\endlist}

\makeatletter
\def\@maketitle{%
  \newpage
%  \null
%  \vskip 2em%
%  \begin{center}%
  \let \footnote \thanks
    {\fontsize{18}{20}\selectfont\raggedright  \setlength{\parindent}{0pt} \@title \par}%
}
%\fi
\makeatother




\setcounter{secnumdepth}{0}

\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}



\title{White Advantage in Chess and How to Counter It  }



\author{\Large Jun Won (Lakon) Park (Group Leader)\vspace{0.05in} \newline\normalsize\emph{79453940, Group Leader, data collection, data analysis, report-writing}   \and \Large Sarah Li\vspace{0.05in} \newline\normalsize\emph{60136959, data collection, data analysis, report-writing}  }


\date{}

\usepackage{titlesec}

\titleformat*{\section}{\normalsize\bfseries}
\titleformat*{\subsection}{\normalsize\itshape}
\titleformat*{\subsubsection}{\normalsize\itshape}
\titleformat*{\paragraph}{\normalsize\itshape}
\titleformat*{\subparagraph}{\normalsize\itshape}


\usepackage{natbib}
\bibliographystyle{plainnat}
\usepackage[strings]{underscore} % protect underscores in most circumstances



\newtheorem{hypothesis}{Hypothesis}
\usepackage{setspace}


% set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother

\usepackage{amsmath}
\usepackage{booktabs}
\usepackage{longtable}
\usepackage{array}
\usepackage{multirow}
\usepackage{wrapfig}
\usepackage{float}
\usepackage{colortbl}
\usepackage{pdflscape}
\usepackage{tabu}
\usepackage{threeparttable}
\usepackage{threeparttablex}
\usepackage[normalem]{ulem}
\usepackage{makecell}
\usepackage{xcolor}

% move the hyperref stuff down here, after header-includes, to allow for - \usepackage{hyperref}

\makeatletter
\@ifpackageloaded{hyperref}{}{%
\ifxetex
  \PassOptionsToPackage{hyphens}{url}\usepackage[setpagesize=false, % page size defined by xetex
              unicode=false, % unicode breaks when used with xetex
              xetex]{hyperref}
\else
  \PassOptionsToPackage{hyphens}{url}\usepackage[draft,unicode=true]{hyperref}
\fi
}

\@ifpackageloaded{color}{
    \PassOptionsToPackage{usenames,dvipsnames}{color}
}{%
    \usepackage[usenames,dvipsnames]{color}
}
\makeatother
\hypersetup{breaklinks=true,
            bookmarks=true,
            pdfauthor={Jun Won (Lakon) Park (Group Leader) (79453940, Group Leader, data collection, data analysis, report-writing) and Sarah Li (60136959, data collection, data analysis, report-writing)},
             pdfkeywords = {},  
            pdftitle={White Advantage in Chess and How to Counter It},
            colorlinks=true,
            citecolor=blue,
            urlcolor=blue,
            linkcolor=magenta,
            pdfborder={0 0 0}}
\urlstyle{same}  % don't use monospace font for urls

% Add an option for endnotes. -----


% add tightlist ----------
\providecommand{\tightlist}{%
\setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% add some other packages ----------

% \usepackage{multicol}
% This should regulate where figures float
% See: https://tex.stackexchange.com/questions/2275/keeping-tables-figures-close-to-where-they-are-mentioned
\usepackage[section]{placeins}


\begin{document}
	
% \pagenumbering{arabic}% resets `page` counter to 1 
%
% \maketitle

{% \usefont{T1}{pnc}{m}{n}
\setlength{\parindent}{0pt}
\thispagestyle{plain}
{\fontsize{18}{20}\selectfont\raggedright 
\maketitle  % title \par  

}

{
   \vskip 13.5pt\relax \normalsize\fontsize{11}{12} 
\textbf{\authorfont Jun Won (Lakon) Park (Group Leader)} \hskip 15pt \emph{\small 79453940, Group Leader, data collection, data analysis, report-writing}   \par \textbf{\authorfont Sarah Li} \hskip 15pt \emph{\small 60136959, data collection, data analysis, report-writing}   

}

}








\begin{abstract}

    \hbox{\vrule height .2pt width 39.14pc}

    \vskip 8.5pt % \small 

\noindent Research question: Is white at an advantage in chess and if so, what are
some optimal strategies for black to increase their winning probability?


    \hbox{\vrule height .2pt width 39.14pc}


\end{abstract}


\vskip -8.5pt


 % removetitleabstract

\noindent  

\hypertarget{introduction}{%
\subsubsection{\texorpdfstring{\textbf{Introduction}}{Introduction}}\label{introduction}}

For several centuries, millions of people worldwide have been playing
chess as a recreational and competitive board game at their homes, in
clubs, in tournaments, and even online nowadays. In the recent decades,
chess has been one of the most popular topic in machine learning and
artificial intelligence. The first move advantage has been researched
extensively since the end of 19th century, and many studies have been
shown that white has an inherent advantage.\\
\newline Although there is a general set of chess openings, less
research has been done on the effects of those openings on the final
outcome. This paper intends to confirm white's first move advantage and
study the relationship between the openings and the victory status. In
particular, we are interested in the openings that are in favour for
Black.\\
\newline This paper's data consists basic player information and game
information of over 20000 chess games played on Lichess, a very popular
internet chess platform. The data includes game length, number of turns,
winner, player elo\(^*\), all moves in Standard Chess Notation, Opening
Eco\(^*\), Opening Name, and Opening Ply\(^*\).\\
\newline Our target population is the data set itself. This paper will
perform simple random sampling and stratified random sampling from the
data set and compare the results obtained from the two different
sampling methods. We will first define a new feature called ``average
elo'' which is a mean of two player's ratings. We will define if a game
is played by beginners if the average elo of the game is below 1200.
These game records will likely negatively affect our result; if there
exists any advantage for certain side, beginners will not likely to be
able to use that advantage in their favour. \newline
----------------------------------------------------------

\begin{flushleft}
Elo : A numerical measurement to quantify a player's skill level\newline
Eco : Standardised code for any given opening\newline
Ply : Number of moves in the opening phase\newline
----------------------------------------------------------
\end{flushleft}

\pagebreak

\hypertarget{sampling-methods}{%
\subsubsection{\texorpdfstring{\textbf{Sampling
methods}}{Sampling methods}}\label{sampling-methods}}

For both sampling methods, we will perform sampling twice - once for the
White parameter estimate and once for Black. In this way, we do not have
to calculate the covariance term which is difficult to calculate as
below. \[Var(X-Y) = Var(X)+Var(Y)-2Cov(X,Y)\] By combining two
independent samples, the variance will increase but we will choose a
sample size that is sufficiently large such that the margin of error is
still small. For every sampling method, we will choose the total sample
size to be 2000 which is approximately 10\% of the population. This
sample size is sufficiently large enough such that the width of our
confidence intervals are small. \newline For stratified sampling, we
will separate the games into 5 different groups based on the average elo
of the game from ``1200-1400'', ``1400-1600'', ``1600-1800'',
``1800-2000'', and ``2000+.'' Players in the same elo range would likely
have similar performance which reduces with-in variation of each group.
The optimal allocation for stratified sampling yields total of 2003
samples. Hence, we have randomly removed one sample each from the three
largest sampled stratas.

\hypertarget{the-parameters-of-interest}{%
\subsubsection{\texorpdfstring{\textbf{The Parameters of
Interest}}{The Parameters of Interest}}\label{the-parameters-of-interest}}

\begin{itemize}
\item White and Black's win rate
\item White and Black's win rate for specific openings
\item White and Black's mean number of turns to win
\end{itemize}

\hypertarget{estimators-and-notations}{%
\subsubsection{\texorpdfstring{\textbf{Estimators and
Notations}}{Estimators and Notations}}\label{estimators-and-notations}}

N = population size\\
n = sample size\\
\(N_h\) = population size of strata h\\
\(n_h\) = sample size of strata h\\
\(S_1\) = first SRS taken from population\\
\(S_2\) = second SRS taken from population\\
\(St_1\) = first StRS taken from population\\
\(St_2\) = second StRS taken from population\\
\(S_{1,d}\) = first SRS taken from population with opening d\\
\(S_{2,d}\) = second SRS taken from population with opening d\\
\(St_{1,d}\) = first StRS taken from population with opening d\\
\(St_{2,d}\) = second StRS taken from population with opening d\\
\(p_{i,W} = 1\) if \(i \in P_{winner = White}\) (if game i's winner is
White)\\
\(p_{i,B} = 1\) if \(i \in P_{winner = Black}\) (if game i's winner is
Black)\\
\(p_{i,d,W} = 1\) if \(i \in P_{winner = White, opening = d}\) (if game
i's winner is White with opening d)\\
\(p_{i,d,B} = 1\) if \(i \in P_{winner = Black, opening = d}\) (if game
i's winner is Black with opening d)\\
\(y_i\) = number of turns took for the winner to win for game i\\
\(\mu_{i,W}\) = y\_i\$ if \(i \in P_{winner = White}\) (if game i's
winner is White)\\
\(\mu_{i,B}\) = y\_i\$ if \(i \in P_{winner = Black}\) (if game i's
winner is Black)\\
\(\bar p_{S_1,W}\) = average of \(p_{i,W}\) for \(i \in S_1\)\\
\(\bar p_{S_2,B}\) = average of \(p_{i,B}\) for \(i \in S_2\)\\
\(\bar p_{S_1,d,W}\) = average of \(p_{i,d,W}\) for \(i \in S_{1,d}\)\\
\(\bar p_{S_2,d,B}\) = average of \(p_{i,d,B}\) for \(i \in S_{2,d}\)\\
\(\bar p_{St_1,h,w}\) = average of \(p_{i,W}\) for \(i \in St_1\) in
strata h\\
\(\bar p_{St_2,h,B}\) = average of \(p_{i,B}\) for \(i \in St_2\) in
strata h\\
\(\bar p_{St_1,h,d,W}\) = average of \(p_{i,d,W}\) for
\(i \in St_{1,d}\) in strata h\\
\(\bar p_{St_2,h,d,B}\) = average of \(p_{i,d,B}\) for
\(i \in St_{2,d}\) in strata h\\
\(\bar \mu_{S_1, W}\) = average of \(\mu_{i,W}\) for \(i \in S_{1,W}\)\\
\(\bar \mu_{S_2, B}\) = average of \(\mu_{i,B}\) for \(i \in S_{2,B}\)\\
\(\bar \mu_{St_1, W}\) = average of \(\mu_{i,W}\) for
\(i \in St_{1,W}\)\\
\(\bar \mu_{St_2, B}\) = average of \(\mu_{i,W}\) for
\(i \in St_{2,B}\)\\
\(\bar \mu_{St_1, h,W}\) = average of \(\mu_{i,W}\) for
\(i \in St_{1,h,W}\) in strata h\\
\(\bar \mu_{St_2, h,B}\) = average of \(\mu_{i,W}\) for
\(i \in St_{2,h,B}\) in strata h\\
\newline White's win rate in the population will be estimated using the
following estimators: \[\hat p_{W} = \bar p_{S_1,W}\]
\[\hat p_{W} = \bar p_{St_1,W} = \sum_{h=1}^{h}\frac{N_h}{N}\bar p_{St_1,h,w}\]
with Standard errors estimated using
\[\hat SE(\hat p_{W}) = \sqrt{(1-\frac{n}{N})\frac{\hat p_{W}(1-\hat p_{W})}{n}}\]
\[\hat SE(\hat p_{W}) = \sqrt{\sum_{h=1}^{5}(\frac{N_h}{N})^2(1-\frac{n_h}{N_h})\frac{\bar p_{St_1,h,W}(1-\bar p_{St_1,h,W})}{n_h}}\]
Black's win rate and stand error in the population will be estimated
using the same formula as above except \(\hat P_{W}\) replaced with
\(\hat P_{B}\), \(S_1\) replaced with \(S_2\), and \(St_1\) replaced
with \(St_2\).\\
\newline The difference in White and Black's win rate in the population
will be estimated using
\[\hat p_{W} - \hat p_{B} = \bar p_{S_1,W} - \bar p_{S_2,B}\]
\[\hat p_{W} - \hat p_{B} = \bar p_{St_1,W} - \bar p_{St_2,B}\] With
pooled standard error with equal sample size \begin{align*}
SE &= \sqrt{\frac{(n-1)((Var(\hat P_W)^2 + Var(\hat P_B)^2)}{2n-2}}\sqrt{\frac{2}{n}}\\
&=\sqrt{\frac{(Var(\hat P_W)^2 + Var(\hat P_B)^2)}{n}}\\
&= \sqrt{SE(\hat P_W)^2 + SE(\hat P_B)^2}
\end{align*} \newline

White's win rate in the population for a given opening will be estimated
using the following estimators: \[\hat p_{d, W} = \bar p_{S_1,d,W} \]
\[\hat p_{d,W} = \bar p_{St_1,d,W} = \sum_{h=1}^{h}\frac{N_h}{N}\bar p_{St_1,h,d,w}\]
with Standard errors estimated using
\[\hat SE(\hat p_{d, W}) = \sqrt{(1-\frac{n}{N})\frac{\hat p_{d, W}(1-\hat p_{d, W})}{n}}\]
\[\hat SE(\hat p_{d, W}) = \sqrt{\sum_{h=1}^{5}(\frac{N_h}{N})^2(1-\frac{n_h}{N_h})\frac{\hat p_{d,h,W}(1-\hat p_{d,h,W})}{n_{h}}}\]
Black's win rate for the given opening and stand error in the population
will be estimated using the same formula as above except
\(\hat P_{d,W}\) replaced with \(\hat P_{d,B}\), \(S_{1,d}\) replaced
with \(S_{2,d}\), and \(St_{1,d}\) replaced with \(St_{2,d}\).

The difference in White and Black's win rate for the given opening in
the population will be estimated using
\[\hat p_{d,W} - \hat p_{d,B} = \bar p_{S_1,d,W} - \bar p_{S_2,d,B}\]
\[\hat p_{d,W} - \hat p_{d,B} = \bar p_{St_1,d,W} - \bar p_{St_2,d,B}\]
With pooled standard error
\[SE = \sqrt{\frac{(n_{d,St_1}-1)Var(\hat P_{d,W})^2 + (n_{d,St_2}-1)Var(\hat P_{d,B})^2}{n_{d,St_1} + n_{d,St_2} -2}}\sqrt{\frac{1}{n_{d,St_1}}
+\frac{1}{n_{d,St_2}}}\] However, this estimate is very tricky to
calculate. Hence, we will assume \(n_{d,St_1} = n_{d,St_2}\) such that
\[SE = \sqrt{\hat SE(\hat p_{d, W})^2 +  \hat SE(\hat p_{d, B})^2}\]
\newline

White's mean number of turns to win in the population will be estimated
using the following estimators: \[\hat \mu_W = \bar \mu_{S_1, W}\]
\[\hat \mu_W = \bar \mu_{St_1, W} = \sum_{h=1}^{h}\frac{N_h}{N}\bar \mu_{St_1,h,w}\]
with Standard errors estimated using
\[\hat SE(\hat \mu_{W}) = \sqrt{(1-\frac{n}{N})\frac{Var(S_1)}{n}}\]
where \(Var(S_1)\) is the variance of turns in \(S_1\)
\[\hat SE(\hat \mu_{W}) = \sqrt{\sum_{h=1}^{5}(\frac{N_h}{N})^2(1-\frac{n_h}{N_h})\frac{Var(S_{1,h})}{n_h}}\]
where \(Var(S_{1,h})\) is the variance of turns in strata h in \(St_1\).

Black's win rate and stand error in the population will be estimated
using the same formula as above except \(\hat P_{W}\) replaced with
\(\hat P_{B}\), \(S_1\) replaced with \(S_2\), and \(St_1\) replaced
with \(St_2\).\\
\newline The difference in White and Black's mean number of turns to win
in the population will be estimated using
\[\hat \mu_{W} - \hat \mu_{B} = \bar \mu_{S_1,W} - \bar \mu_{S_2,B}\]
\[\hat \mu_{W} - \hat \mu_{B} = \bar \mu_{St_1,W} - \bar \mu_{St_2,B}\]
With pooled standard error with equal sample size
\[SE = \sqrt{SE(\hat \mu_W)^2 + SE(\hat \mu_B)^2}\]

\hypertarget{does-white-have-higher-win-rate-than-black}{%
\subsubsection{\texorpdfstring{\textbf{Does White have higher win rate
than
Black?}}{Does White have higher win rate than Black?}}\label{does-white-have-higher-win-rate-than-black}}

We define win rate to be the proportion of games won by each side. To
confirm White's inherent advantage, we will perform two independent
sample t-test to determine whether White has a higher win rate than that
of Black. Hence, we will test the following hypothesis below
\[H_0 : p_w - p_b = 0 \quad  \quad H_a : p_w - p_b > 0\] where \(p_w\)
and \(p_b\) represent White and Black's win rate each respectively.\\
\newline We will assume equal variance among two SRS samples and conduct
t-test using pooled variance. The constructed 95\% confidence interval
is as below:

\begin{table}[h] \centering  
\begin{tabular}{l|r|r}
\hline
  & Win rate Estimate & SE\\
\hline
White & 0.5040 & 0.0105715\\
\hline
Black & 0.4685 & 0.0105509\\
\hline
\end{tabular} \hspace{1cm} \centering  
\begin{tabular}{r|r|r|r}
\hline
Diff & Pooled SE & 95.CI.lower & 95.CI.upper\\
\hline
0.0355 & 0.0149358 & 0.0062263 & 0.0647737\\
\hline
\end{tabular} \end{table}

The constructed 95\% confidence interval is \((0.0062, 0.0648)\) which
does not contain 0. Hence, we can reject the null hypothesis in favour
of the alternative hypothesis that White has a higher winning
proportion.\\
\newline We will assume equal variance among two StRS samples and
conduct t-test using pooled variance. The constructed 95\% confidence
interval is as below: \newline

\begin{table}[h] \centering  
\begin{tabular}{l|l|r|r|r}
\hline
elo range & winner & win rate est. & strata size & Var. by strata\\
\hline
1200-1400 & white & 0.5217391 & 391 & 0.0006382\\
\hline
1400-1600 & white & 0.5069552 & 647 & 0.0003863\\
\hline
1600-1800 & white & 0.4898785 & 494 & 0.0005059\\
\hline
1800-2000 & white & 0.5143770 & 313 & 0.0007981\\
\hline
2000+ & white & 0.5032258 & 155 & 0.0016128\\
\hline
\end{tabular} \hspace{1cm} \centering  
\begin{tabular}{l|l|r|r|r}
\hline
elo range & winner & win rate est. & strata size & Var. by strata\\
\hline
1200-1400 & black & 0.4884910 & 391 & 0.0006390\\
\hline
1400-1600 & black & 0.4544049 & 647 & 0.0003832\\
\hline
1600-1800 & black & 0.4534413 & 494 & 0.0005017\\
\hline
1800-2000 & black & 0.4423077 & 312 & 0.0007906\\
\hline
2000+ & black & 0.4358974 & 156 & 0.0015762\\
\hline
\end{tabular} \hspace{1cm} \centering  
\begin{tabular}{l|r}
\hline
elo range & strata size prop.\\
\hline
1200-1400 & 0.1949283\\
\hline
1400-1600 & 0.3219334\\
\hline
1600-1800 & 0.2470221\\
\hline
1800-2000 & 0.1568638\\
\hline
2000+ & 0.0790407\\
\hline
\end{tabular} \hspace{1cm} \centering  
\begin{tabular}{l|r|r}
\hline
  & Win rate Estimate & SE\\
\hline
White & 0.5063808 & 0.0078503\\
\hline
Black & 0.4573546 & 0.0081990\\
\hline
\end{tabular} \hspace{1cm} \centering  
\begin{tabular}{r|r|r|r}
\hline
Diff & Pooled SE & 95.CI.lower & 95.CI.upper\\
\hline
0.0490262 & 0.0113512 & 0.0267782 & 0.0712742\\
\hline
\end{tabular} \end{table}
\newpage

The constructed 95\% confidence interval is \((0.0268, 0.0713)\) which
does not contain 0. Hence, we can reject the null hypothesis in favour
of the alternative hypothesis that White has a higher winning
proportion.\\
\newline The result from both SRS and StRS show that White has a higher
winning proportion. Such phenomenon could be due to white having a
first-move advantage. \newpage

\hypertarget{what-is-an-optimal-game-opening-for-black}{%
\subsubsection{\texorpdfstring{\textbf{What is an optimal game opening
for
Black?}}{What is an optimal game opening for Black?}}\label{what-is-an-optimal-game-opening-for-black}}

Due to the many possible openings a game can start with, the sample size
in each possible domain (split by opening) may be very small. In order
to ensure that the confidence interval is of reasonable width, we will
only estimate within the domain if its sample size yields a confidence
interval including \(\pm 0.2\) of our estimate of win rate. In the worst
case, the win rate of Black is the same as that of White. Hence, using
an initial guess of \(p=0.5\), the minimum sample size is at least 25.
Since we know the domain size of each opening, the resulting minimum
sample size for each opening will differ and will be less than 25.
\newline

\begin{tabular}{l|r|r}
\hline
opening name & size of sample 1 & size of sample 2\\
\hline
French Defense: Knight Variation & 28 & 22\\
\hline
Scandinavian Defense: Mieses-Kotroc Variation & 31 & 24\\
\hline
Scotch Game & 35 & 23\\
\hline
Sicilian Defense & 35 & 39\\
\hline
Sicilian Defense: Bowdler Attack & 41 & 32\\
\hline
Van't Kruijs Opening & 24 & 33\\
\hline
\end{tabular}

\(~\)\newline Again, using the openings above, we test the same
hypothesis as above. The resulting confidence interval is as below:

\begin{table}[!h]
\centering
\resizebox{\linewidth}{!}{
\begin{tabular}{l|r|r|r|r}
\hline
opening name & Diff. win rate & SE & 95.CI.lower & 95.CI.upper\\
\hline
French Defense: Knight Variation & -0.0909091 & 0.1413246 & -0.3750612 & 0.1932430\\
\hline
Scandinavian Defense: Mieses-Kotroc Variation & 0.3346774 & 0.1269533 & 0.0800413 & 0.5893135\\
\hline
Scotch Game & 0.1962733 & 0.1276304 & -0.0594011 & 0.4519477\\
\hline
Sicilian Defense & -0.1355311 & 0.1152343 & -0.3652465 & 0.0941842\\
\hline
Sicilian Defense: Bowdler Attack & -0.0228659 & 0.1164512 & -0.2550629 & 0.2093312\\
\hline
Van't Kruijs Opening & -0.1704545 & 0.1319470 & -0.4348822 & 0.0939731\\
\hline
\end{tabular}}
\end{table}

Using SRS sampling and assuming equal variances, all openings but
``Scandinavian Defense: Mieses-Kotroc Variation'' contain 0 in their
95\% confidence intervals. For these openings, we cannot reject the null
hypothesis which states that there is no difference in win rates. More
specifically, there is insufficient evidence to suggest that black has a
higher win rate when these openings are used. For the intervals that are
strictly greater than 0, there is sufficient evidence to reject the null
hypothesis in favour of the alternative hypothesis that White has higher
win rate. In all, there is no opening that yields higher win rate for
Black.

Using StRS, we will again determine the valid openings in two different
samples and test the same hypothesis. \newline

\begin{tabular}{l|r|r}
\hline
opening name & size of sample 1 & size of sample 2\\
\hline
French Defense: Knight Variation & 28 & 22\\
\hline
Scandinavian Defense: Mieses-Kotroc Variation & 31 & 24\\
\hline
Scotch Game & 35 & 23\\
\hline
Sicilian Defense & 35 & 39\\
\hline
Sicilian Defense: Bowdler Attack & 41 & 32\\
\hline
Van't Kruijs Opening & 24 & 33\\
\hline
\end{tabular}

\(~\) \newline The resulting confidence interval for the openings above
is as follows:

\begin{table}[!h]
\centering
\resizebox{\linewidth}{!}{
\begin{tabular}{l|r|r|r|r}
\hline
opening name & Diff. win rate & SE & 95.CI.lower & 95.CI.upper\\
\hline
French Defense: Knight Variation & 0.0426424 & 0.1230920 & -0.2039406 & 0.2892254\\
\hline
Scandinavian Defense: Mieses-Kotroc Variation & 0.2094644 & 0.1159952 & -0.0226415 & 0.4415702\\
\hline
Scotch Game & -0.0172765 & 0.1219349 & -0.2617412 & 0.2271882\\
\hline
Sicilian Defense & -0.1609474 & 0.1026540 & -0.3651967 & 0.0433019\\
\hline
Sicilian Defense: Bowdler Attack & -0.1600468 & 0.1278376 & -0.4168162 & 0.0967227\\
\hline
Van't Kruijs Opening & -0.3068106 & 0.0923759 & -0.4923531 & -0.1212681\\
\hline
\end{tabular}}
\end{table}
\newpage

The confidence interval for opening ``Van't Kruijs Opening'' is strictly
negative. This suggests that for this opening, Black has a higher win
rate than White. For other openings with confidence intervals that
contain 0, we cannot reject the null hypothesis which states that there
is no difference in win rates. More specifically, there is insufficient
evidence to suggest that black has a higher win rate when these openings
are used.\\
\newline Since SRS and StRS sample contain different valid openings, it
is not possible to compare the results. However, we have found an
opening in which Black has a higher win rate. \newpage

\hypertarget{does-it-take-longer-for-black-to-win}{%
\subsubsection{\texorpdfstring{\textbf{Does it take longer for Black to
win?}}{Does it take longer for Black to win?}}\label{does-it-take-longer-for-black-to-win}}

We have already confirmed that White has a first-move advantage over
Black. So how does Black actually overcome this advantage? Our
hypothesis is that Black will need to spend extra turns to overcome the
disadvantage in the beginning. This leads to increase an increase in
overall turn spent by Black to win. Hence, we will test the following
hypothesis,
\[H_0 : \mu_W - \mu_B = 0 \quad \quad H_a: \mu_W - \mu_B < 0\] where
\(\mu_W\) and \(\mu_B\) represent White and Black's mean number of turns
to win each respectively.\\
\newline We will assume equal variance among two SRS samples and conduct
t-test using pooled variance. The constructed 95\% confidence interval
is as below.

\begin{table}[h] \centering  
\begin{tabular}{l|r|r}
\hline
  & Est. & SE\\
\hline
White & 57.68849 & 0.9787740\\
\hline
Black & 60.52721 & 0.9840654\\
\hline
\end{tabular} \hspace{1cm} \centering  
\begin{tabular}{r|r|r|r}
\hline
Diff & SE & 95.CI.lower & 95.CI.upper\\
\hline
-2.838722 & 1.362178 & -5.508543 & -0.1689018\\
\hline
\end{tabular} \end{table}

The constructed confidence interval does not contain 0 which implies
there is sufficient evidence to reject the null hypothesis in favour of
the alternative hypothesis that Black takes longer to win.\\
\newline Using StRS and assuming equal variance,

\begin{table}[h] \centering  
\begin{tabular}{l|r}
\hline
elo range & mean turns for white\\
\hline
1200-1400 & 51.26471\\
\hline
1400-1600 & 55.52744\\
\hline
1600-1800 & 60.51653\\
\hline
1800-2000 & 65.25466\\
\hline
2000+ & 55.08974\\
\hline
\end{tabular} \hspace{1cm} \centering  
\begin{tabular}{l|r}
\hline
elo range & mean turns for black\\
\hline
1200-1400 & 55.90052\\
\hline
1400-1600 & 57.77551\\
\hline
1600-1800 & 60.82143\\
\hline
1800-2000 & 65.34783\\
\hline
2000+ & 72.05882\\
\hline
\end{tabular} \end{table}\begin{table}[h] \centering  
\begin{tabular}{l|r|r|l}
\hline
elo range & strata size & var. by strata & winner\\
\hline
1200-1400 & 391 & 1.725542 & white\\
\hline
1400-1600 & 647 & 1.235008 & white\\
\hline
1600-1800 & 494 & 1.563627 & white\\
\hline
1800-2000 & 313 & 3.240864 & white\\
\hline
2000+ & 155 & 4.484618 & white\\
\hline
\end{tabular} \hspace{0.5cm} \centering  
\begin{tabular}{l|r|r|l}
\hline
elo range & strata size & var. by strata & winner\\
\hline
1200-1400 & 391 & 2.331782 & black\\
\hline
1400-1600 & 647 & 1.338437 & black\\
\hline
1600-1800 & 494 & 1.553842 & black\\
\hline
1800-2000 & 312 & 3.169745 & black\\
\hline
2000+ & 156 & 6.058140 & black\\
\hline
\end{tabular} \end{table}\begin{table}[!h]
\centering
\begin{tabular}{r|r|r|r}
\hline
Diff & Pooled SE & 95.CI.lower & 95.CI.upper\\
\hline
-3.058561 & 1.175147 & -5.361806 & -0.7553155\\
\hline
\end{tabular}
\end{table}
\newpage

The constructed confidence interval does not contain 0 which implies
there is sufficient evidence to reject the null hypothesis in favour of
the alternative hypothesis that Black takes longer to win.\\
\newline

\hypertarget{conclusion}{%
\subsubsection{\texorpdfstring{\textbf{Conclusion}}{Conclusion}}\label{conclusion}}

From our analysis of win rate, we have even more reason to believe that
White has a first-move advantage. Both SRS and StRS with optimal
allocation produced estimates which suggest a significant difference
between Black and White win rate. \newline Furthermore, we discovered
through StRS that there are openings with greater win rates for Black
side. Our choice of stratifying by ``average elo'' may have been
effective in lowering variance of our estimate, as players in the same
elo range would likely have similar performance. Estimates of win rate
per opening suffer from the limitation of sample size, since the
abundance of possible openings leads to very few observations of each
opening. There may be other openings which are more advantageous for
Black side, but are rarely used by players on Lichess.\\
\newline While the Black side cannot easily change which opening White
starts with, they can attempt to play more turns to overcome White's
early-game advantage. Our analysis of average number of turns produced
results indicating that games won by Black side involve more turns.\\
\newline Moreover, it is crucial to note that SRS and StRS yielded the
same result yet StRS produced smaller standard errors for each estimate.
The advantage of SRS is that it eases the difficulty of standard error
calculation. However, the disadvantage of SRS is that due to the
simplistic nature of the sampling, the standard error calculation yields
a larger standard error than that of StRS.\\
\newline We cannot assume that our sample from Lichess is representative
of the entire population of chess players due to differences in the
nature of online chess and traditional chess. For example, online elo
could be less indicative of actual skill, due to randomness of opponents
and lack of formality. However, our results could possibly be extended
to other online chess platforms, such as
\href{https://www.chess.com/}{Chess.com} and
\href{https://chess24.com/en}{chess24}, which likely have similar
players. Our new knowledge of openings and game length favouring Black
side could be used to try and overcome first-move advantage in online
chess. \newpage

\begin{center}
\Large{Appendix}
\end{center}

\noindent Dataset: \url{https://www.kaggle.com/datasnaek/chess}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Load data}
\NormalTok{df <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\StringTok{"games.csv"}\NormalTok{)}

\CommentTok{# Calculate the average elo of the game}
\NormalTok{df <-}\StringTok{ }\KeywordTok{mutate}\NormalTok{(df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{rowwise}\NormalTok{(),}
       \DataTypeTok{average_elo =} \KeywordTok{rowMeans}\NormalTok{(}\KeywordTok{cbind}\NormalTok{(black_rating, white_rating)))}

\CommentTok{# Filter games by average elo}
\NormalTok{df <-}\StringTok{ }\KeywordTok{filter}\NormalTok{(df, average_elo }\OperatorTok{>=}\StringTok{ }\DecValTok{1200}\NormalTok{)}

\CommentTok{# Select only necessary columns for analysis}
\NormalTok{df <-}\StringTok{ }\KeywordTok{subset}\NormalTok{(df, }
             \DataTypeTok{select =} \KeywordTok{c}\NormalTok{(id, turns, white_rating, black_rating, victory_status, }
\NormalTok{                        winner, moves, opening_eco, opening_name, opening_ply, }
\NormalTok{                        average_elo ))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Simple Random Sampling}
\NormalTok{N <-}\StringTok{ }\KeywordTok{nrow}\NormalTok{(df)}
\NormalTok{n <-}\StringTok{ }\DecValTok{2000}
\KeywordTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{sample.index.s1 <-}\StringTok{ }\KeywordTok{sample}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\NormalTok{N, }\DataTypeTok{size=}\NormalTok{n, }\DataTypeTok{replace =} \OtherTok{FALSE}\NormalTok{)}
\NormalTok{srs.sample.s1 <-}\StringTok{ }\NormalTok{df[sample.index.s1,]}

\KeywordTok{set.seed}\NormalTok{(}\DecValTok{4321}\NormalTok{)}
\NormalTok{sample.index.s2 <-}\StringTok{ }\KeywordTok{sample}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\NormalTok{N, }\DataTypeTok{size=}\NormalTok{n, }\DataTypeTok{replace =} \OtherTok{FALSE}\NormalTok{)}
\NormalTok{srs.sample.s2 <-}\StringTok{ }\NormalTok{df[sample.index.s2,]}
\NormalTok{knitr}\OperatorTok{::}\KeywordTok{kable}\NormalTok{(table1)}

\CommentTok{# Determine minimum and maximum before stratifying}
\KeywordTok{min}\NormalTok{(df}\OperatorTok{$}\NormalTok{average_elo)}
\KeywordTok{max}\NormalTok{(df}\OperatorTok{$}\NormalTok{average_elo)}

\NormalTok{df}\OperatorTok{$}\NormalTok{elo_range <-}\StringTok{ }\KeywordTok{cut}\NormalTok{(df}\OperatorTok{$}\NormalTok{average_elo,}
                    \KeywordTok{c}\NormalTok{(}\DecValTok{1200}\NormalTok{, }\DecValTok{1400}\NormalTok{, }\DecValTok{1600}\NormalTok{, }\DecValTok{1800}\NormalTok{, }\DecValTok{2000}\NormalTok{, }\DecValTok{2600}\NormalTok{))}
\KeywordTok{levels}\NormalTok{(df}\OperatorTok{$}\NormalTok{elo_range) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"1200-1400"}\NormalTok{, }\StringTok{"1400-1600"}\NormalTok{, }\StringTok{"1600-1800"}\NormalTok{, }\StringTok{"1800-2000"}\NormalTok{,}
                          \StringTok{"2000+"}\NormalTok{)}
\NormalTok{df}\OperatorTok{$}\NormalTok{winner <-}\StringTok{ }\KeywordTok{as.factor}\NormalTok{(df}\OperatorTok{$}\NormalTok{winner)}

\CommentTok{# Check if standard deviations of the strata are identical}
\NormalTok{se.by.strata <-}\StringTok{ }\KeywordTok{aggregate}\NormalTok{(}\KeywordTok{as.numeric}\NormalTok{(df}\OperatorTok{$}\NormalTok{winner), }\DataTypeTok{by=}\KeywordTok{list}\NormalTok{(df}\OperatorTok{$}\NormalTok{elo_range), }\DataTypeTok{FUN=}\NormalTok{sd)}
\NormalTok{se.by.strata}

\CommentTok{# Standard deviations within strata are not identical, \textbackslash{}}
\CommentTok{# so find optimal sample sizes}
\NormalTok{pop.size.by.strata <-}\StringTok{ }\KeywordTok{aggregate}\NormalTok{(df}\OperatorTok{$}\NormalTok{winner, }\DataTypeTok{by=}\KeywordTok{list}\NormalTok{(df}\OperatorTok{$}\NormalTok{elo_range), }\DataTypeTok{FUN=}\NormalTok{length)}
\NormalTok{denom <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(pop.size.by.strata[}\DecValTok{2}\NormalTok{] }\OperatorTok{*}\StringTok{ }\NormalTok{se.by.strata[}\DecValTok{2}\NormalTok{])}
\NormalTok{sample.size.by.strata <-}\StringTok{ }\NormalTok{(pop.size.by.strata[}\DecValTok{2}\NormalTok{] }\OperatorTok{*}\StringTok{ }\NormalTok{se.by.strata[}\DecValTok{2}\NormalTok{]) }\OperatorTok{/}\StringTok{ }\NormalTok{denom}

\CommentTok{# Sample from each strata}
\NormalTok{strsample <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(df, sample.size.by.strata, n, seed) \{}
\NormalTok{  str.sample <-}\StringTok{ }\NormalTok{df[}\OtherTok{FALSE}\NormalTok{,]}
  \KeywordTok{colnames}\NormalTok{(str.sample) <-}\StringTok{ }\KeywordTok{names}\NormalTok{(df)}
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(}\KeywordTok{levels}\NormalTok{(df}\OperatorTok{$}\NormalTok{elo_range))) \{}
\NormalTok{    strata <-}\StringTok{ }\KeywordTok{which}\NormalTok{(df}\OperatorTok{$}\NormalTok{elo_range }\OperatorTok{==}\StringTok{ }\KeywordTok{levels}\NormalTok{(df}\OperatorTok{$}\NormalTok{elo_range)[i])}
    \KeywordTok{set.seed}\NormalTok{(seed)}
\NormalTok{    sample.idx <-}\StringTok{ }\KeywordTok{sample}\NormalTok{(strata, }
                             \DataTypeTok{size =} \KeywordTok{ceiling}\NormalTok{(sample.size.by.strata}\OperatorTok{$}\NormalTok{x[i] }\OperatorTok{*}\StringTok{ }\NormalTok{n), }
                             \DataTypeTok{replace =} \OtherTok{FALSE}\NormalTok{)}
\NormalTok{    sample <-}\StringTok{ }\NormalTok{df[sample.idx,]}
\NormalTok{    str.sample <-}\StringTok{ }\KeywordTok{rbind}\NormalTok{(str.sample, sample)}
\NormalTok{  \}}
  
  \CommentTok{# Stratified sample contains 1003 samples due to rounding of the proportions,}
  \CommentTok{# so we randomly remove three from random strata}
\NormalTok{  strata.for.removal <-}\StringTok{ }\KeywordTok{sample}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\DecValTok{5}\NormalTok{, }\DecValTok{2}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (s }\ControlFlowTok{in}\NormalTok{ strata.for.removal) \{}
    \KeywordTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{    to.remove <-}\StringTok{ }\KeywordTok{sample}\NormalTok{(}\KeywordTok{which}\NormalTok{(str.sample}\OperatorTok{$}\NormalTok{elo_range }\OperatorTok{==}\StringTok{ }\KeywordTok{levels}\NormalTok{(df}\OperatorTok{$}\NormalTok{elo_range)[s]), }\DecValTok{1}\NormalTok{)}
\NormalTok{    str.sample <-}\StringTok{ }\NormalTok{str.sample[}\OperatorTok{-}\NormalTok{to.remove,]}
\NormalTok{  \}}
  
  \KeywordTok{return}\NormalTok{(str.sample)}
\NormalTok{\}}

\NormalTok{white.str.sample <-}\StringTok{ }\KeywordTok{strsample}\NormalTok{(df, sample.size.by.strata, n, }\DecValTok{1234}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(elo_range) }
\NormalTok{black.str.sample <-}\StringTok{ }\KeywordTok{strsample}\NormalTok{(df, sample.size.by.strata, n, }\DecValTok{4321}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(elo_range) }
\NormalTok{z}\FloatTok{.95}\NormalTok{ <-}\StringTok{ }\KeywordTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{)}
\CommentTok{# Returns the sample variance of a given proportion}
\NormalTok{var.est <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(p) \{}
\NormalTok{  p }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p)}
\NormalTok{\}}
\CommentTok{# Calculate white's win rate}
\NormalTok{white.prop <-}\StringTok{ }\NormalTok{srs.sample.s1 }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{count}\NormalTok{(winner) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(winner) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{win.prop =}\NormalTok{ n }\OperatorTok{/}\StringTok{ }\DecValTok{2000}\NormalTok{)}

\NormalTok{white.p <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(white.prop[}\DecValTok{3}\NormalTok{,}\DecValTok{3}\NormalTok{])}

\NormalTok{black.prop <-}\StringTok{ }\NormalTok{srs.sample.s2 }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{count}\NormalTok{(winner) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(winner) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{win.prop =}\NormalTok{ n }\OperatorTok{/}\StringTok{ }\DecValTok{2000}\NormalTok{)}

\NormalTok{black.p <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(black.prop[}\DecValTok{1}\NormalTok{,}\DecValTok{3}\NormalTok{])}
\NormalTok{white.var <-}\StringTok{ }\NormalTok{(}\DecValTok{1}\OperatorTok{-}\NormalTok{n}\OperatorTok{/}\NormalTok{N)}\OperatorTok{*}\NormalTok{(}\KeywordTok{var.est}\NormalTok{(white.p)}\OperatorTok{/}\NormalTok{n)}
\NormalTok{black.var <-}\StringTok{ }\NormalTok{(}\DecValTok{1}\OperatorTok{-}\NormalTok{n}\OperatorTok{/}\NormalTok{N)}\OperatorTok{*}\NormalTok{(}\KeywordTok{var.est}\NormalTok{(black.p)}\OperatorTok{/}\NormalTok{n)}
\NormalTok{srs.se <-}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(white.var }\OperatorTok{+}\StringTok{ }\NormalTok{black.var)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Determine minimum and maximum before stratifying}
\KeywordTok{min}\NormalTok{(df}\OperatorTok{$}\NormalTok{average_elo)}
\KeywordTok{max}\NormalTok{(df}\OperatorTok{$}\NormalTok{average_elo)}

\NormalTok{df}\OperatorTok{$}\NormalTok{elo_range <-}\StringTok{ }\KeywordTok{cut}\NormalTok{(df}\OperatorTok{$}\NormalTok{average_elo,}
                    \KeywordTok{c}\NormalTok{(}\DecValTok{1200}\NormalTok{, }\DecValTok{1400}\NormalTok{, }\DecValTok{1600}\NormalTok{, }\DecValTok{1800}\NormalTok{, }\DecValTok{2000}\NormalTok{, }\DecValTok{2600}\NormalTok{))}
\KeywordTok{levels}\NormalTok{(df}\OperatorTok{$}\NormalTok{elo_range) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"1200-1400"}\NormalTok{, }\StringTok{"1400-1600"}\NormalTok{, }\StringTok{"1600-1800"}\NormalTok{, }\StringTok{"1800-2000"}\NormalTok{,}
                          \StringTok{"2000+"}\NormalTok{)}
\NormalTok{df}\OperatorTok{$}\NormalTok{winner <-}\StringTok{ }\KeywordTok{as.factor}\NormalTok{(df}\OperatorTok{$}\NormalTok{winner)}

\CommentTok{# Check if standard deviations of the strata are identical}
\NormalTok{se.by.strata <-}\StringTok{ }\KeywordTok{aggregate}\NormalTok{(}\KeywordTok{as.numeric}\NormalTok{(df}\OperatorTok{$}\NormalTok{winner), }\DataTypeTok{by=}\KeywordTok{list}\NormalTok{(df}\OperatorTok{$}\NormalTok{elo_range), }\DataTypeTok{FUN=}\NormalTok{sd)}
\NormalTok{se.by.strata}

\CommentTok{# Standard deviations within strata are not identical, \textbackslash{}}
\CommentTok{# so find optimal sample sizes}
\NormalTok{pop.size.by.strata <-}\StringTok{ }\KeywordTok{aggregate}\NormalTok{(df}\OperatorTok{$}\NormalTok{winner, }\DataTypeTok{by=}\KeywordTok{list}\NormalTok{(df}\OperatorTok{$}\NormalTok{elo_range), }\DataTypeTok{FUN=}\NormalTok{length)}
\NormalTok{denom <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(pop.size.by.strata[}\DecValTok{2}\NormalTok{] }\OperatorTok{*}\StringTok{ }\NormalTok{se.by.strata[}\DecValTok{2}\NormalTok{])}
\NormalTok{sample.size.by.strata <-}\StringTok{ }\NormalTok{(pop.size.by.strata[}\DecValTok{2}\NormalTok{] }\OperatorTok{*}\StringTok{ }\NormalTok{se.by.strata[}\DecValTok{2}\NormalTok{]) }\OperatorTok{/}\StringTok{ }\NormalTok{denom}

\CommentTok{# Sample from each strata}
\NormalTok{strsample <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(df, sample.size.by.strata, n, seed) \{}
\NormalTok{  str.sample <-}\StringTok{ }\NormalTok{df[}\OtherTok{FALSE}\NormalTok{,]}
  \KeywordTok{colnames}\NormalTok{(str.sample) <-}\StringTok{ }\KeywordTok{names}\NormalTok{(df)}
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(}\KeywordTok{levels}\NormalTok{(df}\OperatorTok{$}\NormalTok{elo_range))) \{}
\NormalTok{    strata <-}\StringTok{ }\KeywordTok{which}\NormalTok{(df}\OperatorTok{$}\NormalTok{elo_range }\OperatorTok{==}\StringTok{ }\KeywordTok{levels}\NormalTok{(df}\OperatorTok{$}\NormalTok{elo_range)[i])}
    \KeywordTok{set.seed}\NormalTok{(seed)}
\NormalTok{    sample.idx <-}\StringTok{ }\KeywordTok{sample}\NormalTok{(strata, }
                             \DataTypeTok{size =} \KeywordTok{ceiling}\NormalTok{(sample.size.by.strata}\OperatorTok{$}\NormalTok{x[i] }\OperatorTok{*}\StringTok{ }\NormalTok{n), }
                             \DataTypeTok{replace =} \OtherTok{FALSE}\NormalTok{)}
\NormalTok{    sample <-}\StringTok{ }\NormalTok{df[sample.idx,]}
\NormalTok{    str.sample <-}\StringTok{ }\KeywordTok{rbind}\NormalTok{(str.sample, sample)}
\NormalTok{  \}}
  
  \CommentTok{# Stratified sample contains 1003 samples due to rounding of the proportions,}
  \CommentTok{# so we randomly remove three from random strata}
\NormalTok{  strata.for.removal <-}\StringTok{ }\KeywordTok{sample}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\DecValTok{5}\NormalTok{, }\DecValTok{2}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (s }\ControlFlowTok{in}\NormalTok{ strata.for.removal) \{}
    \KeywordTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{    to.remove <-}\StringTok{ }\KeywordTok{sample}\NormalTok{(}\KeywordTok{which}\NormalTok{(str.sample}\OperatorTok{$}\NormalTok{elo_range }\OperatorTok{==}\StringTok{ }\KeywordTok{levels}\NormalTok{(df}\OperatorTok{$}\NormalTok{elo_range)[s]), }\DecValTok{1}\NormalTok{)}
\NormalTok{    str.sample <-}\StringTok{ }\NormalTok{str.sample[}\OperatorTok{-}\NormalTok{to.remove,]}
\NormalTok{  \}}
  
  \KeywordTok{return}\NormalTok{(str.sample)}
\NormalTok{\}}

\NormalTok{white.str.sample <-}\StringTok{ }\KeywordTok{strsample}\NormalTok{(df, sample.size.by.strata, n, }\DecValTok{1234}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(elo_range) }
\NormalTok{black.str.sample <-}\StringTok{ }\KeywordTok{strsample}\NormalTok{(df, sample.size.by.strata, n, }\DecValTok{4321}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(elo_range) }
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{z}\FloatTok{.95}\NormalTok{ <-}\StringTok{ }\KeywordTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{)}
\CommentTok{# Returns the sample variance of a given proportion}
\NormalTok{var.est <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(p) \{}
\NormalTok{  p }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p)}
\NormalTok{\}}
\CommentTok{# Calculate white's win rate}
\NormalTok{white.prop <-}\StringTok{ }\NormalTok{srs.sample.s1 }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{count}\NormalTok{(winner) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(winner) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{win.prop =}\NormalTok{ n }\OperatorTok{/}\StringTok{ }\DecValTok{2000}\NormalTok{)}

\NormalTok{white.p <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(white.prop[}\DecValTok{3}\NormalTok{,}\DecValTok{3}\NormalTok{])}

\NormalTok{black.prop <-}\StringTok{ }\NormalTok{srs.sample.s2 }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{count}\NormalTok{(winner) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(winner) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{win.prop =}\NormalTok{ n }\OperatorTok{/}\StringTok{ }\DecValTok{2000}\NormalTok{)}

\NormalTok{black.p <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(black.prop[}\DecValTok{1}\NormalTok{,}\DecValTok{3}\NormalTok{])}

\NormalTok{srs.se <-}\StringTok{ }\KeywordTok{sqrt}\NormalTok{((}\DecValTok{1}\OperatorTok{-}\NormalTok{n}\OperatorTok{/}\NormalTok{N)}\OperatorTok{*}\NormalTok{(}\KeywordTok{var.est}\NormalTok{(white.p) }\OperatorTok{+}\StringTok{ }\KeywordTok{var.est}\NormalTok{(black.p))}\OperatorTok{/}\NormalTok{n)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Calculate Nh/N, the strata proportion}
\NormalTok{Nh <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{count}\NormalTok{(elo_range, }\DataTypeTok{.drop=}\OtherTok{FALSE}\NormalTok{)}
\NormalTok{Nh <-}\StringTok{ }\NormalTok{Nh[}\KeywordTok{complete.cases}\NormalTok{(Nh),]}

\NormalTok{nh.white <-}\StringTok{ }\NormalTok{white.str.sample }\OperatorTok{%>%}\StringTok{ }\KeywordTok{count}\NormalTok{(elo_range, }\DataTypeTok{.drop=}\OtherTok{FALSE}\NormalTok{)}
\NormalTok{nh.black <-}\StringTok{ }\NormalTok{black.str.sample }\OperatorTok{%>%}\StringTok{ }\KeywordTok{count}\NormalTok{(elo_range, }\DataTypeTok{.drop=}\OtherTok{FALSE}\NormalTok{)}
\NormalTok{strata.size.prop <-}\StringTok{ }\NormalTok{Nh[}\DecValTok{2}\NormalTok{] }\OperatorTok{/}\StringTok{ }\NormalTok{N}

\CommentTok{# Calculate white's win proportion by each strata}
\NormalTok{white.win.prop <-}\StringTok{ }\NormalTok{white.str.sample }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{count}\NormalTok{(winner) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(elo_range) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{win.prop =}\NormalTok{ n }\OperatorTok{/}\StringTok{ }\KeywordTok{sum}\NormalTok{(n))}

\CommentTok{# The estimated aggregated win proportion for white}
\NormalTok{white.prop <-}\StringTok{ }\NormalTok{white.win.prop[white.win.prop}\OperatorTok{$}\NormalTok{winner }\OperatorTok{==}\StringTok{ "white"}\NormalTok{, ] }
\NormalTok{white.p.str.est <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(white.prop}\OperatorTok{$}\NormalTok{win.prop }\OperatorTok{*}\StringTok{ }\NormalTok{strata.size.prop)}

\CommentTok{# The estimated aggregated variance of win proportion for white}
\NormalTok{white.se.by.strata <-}\StringTok{ }\KeywordTok{bind_cols}\NormalTok{(white.prop, }\DataTypeTok{nh =}\NormalTok{ nh.white}\OperatorTok{$}\NormalTok{n)}
\NormalTok{white.se.by.strata <-}\StringTok{ }\NormalTok{white.se.by.strata }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{var.by.strata =}\NormalTok{ win.prop }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1}\OperatorTok{-}\NormalTok{win.prop)}\OperatorTok{/}\NormalTok{nh)}
\NormalTok{white.se.by.strata <-}\StringTok{ }\KeywordTok{bind_cols}\NormalTok{(white.se.by.strata, }\DataTypeTok{strata.prop.sq =}\NormalTok{ strata.size.prop}\OperatorTok{$}\NormalTok{n}\OperatorTok{^}\DecValTok{2}\NormalTok{)}
\NormalTok{white.se.by.strata <-}\StringTok{ }\NormalTok{white.se.by.strata }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(strata.prop.sq}\OperatorTok{*}\NormalTok{(}\DecValTok{1}\OperatorTok{-}\NormalTok{n}\OperatorTok{/}\NormalTok{nh)}\OperatorTok{*}\NormalTok{var.by.strata)}
\NormalTok{white.str.se <-}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(}\KeywordTok{sum}\NormalTok{(white.se.by.strata}\OperatorTok{$}\StringTok{`}\DataTypeTok{strata.prop.sq * (1 - n/nh) * var.by.strata}\StringTok{`}\NormalTok{))}

\CommentTok{# Calculate black's win proportion by each strata}
\NormalTok{black.win.prop <-}\StringTok{ }\NormalTok{black.str.sample }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{count}\NormalTok{(winner) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(elo_range) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{win.prop =}\NormalTok{ n }\OperatorTok{/}\StringTok{ }\KeywordTok{sum}\NormalTok{(n))}

\CommentTok{# The estimated aggregated win proportion for white}
\NormalTok{black.prop <-}\StringTok{ }\NormalTok{black.win.prop[black.win.prop}\OperatorTok{$}\NormalTok{winner }\OperatorTok{==}\StringTok{ "black"}\NormalTok{, ] }
\NormalTok{black.p.str.est <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(black.prop}\OperatorTok{$}\NormalTok{win.prop }\OperatorTok{*}\StringTok{ }\NormalTok{strata.size.prop)}

\CommentTok{# The estimated aggregated variance of win proportion for black}
\NormalTok{black.se.by.strata <-}\StringTok{ }\KeywordTok{bind_cols}\NormalTok{(black.prop, }\DataTypeTok{nh =}\NormalTok{ nh.black}\OperatorTok{$}\NormalTok{n)}
\NormalTok{black.se.by.strata <-}\StringTok{ }\NormalTok{black.se.by.strata }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{var.by.strata =}\NormalTok{ win.prop }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1}\OperatorTok{-}\NormalTok{win.prop)}\OperatorTok{/}\NormalTok{nh)}
\NormalTok{black.se.by.strata <-}\StringTok{ }\KeywordTok{bind_cols}\NormalTok{(black.se.by.strata, }\DataTypeTok{strata.prop.sq =}\NormalTok{ strata.size.prop}\OperatorTok{$}\NormalTok{n}\OperatorTok{^}\DecValTok{2}\NormalTok{)}
\NormalTok{black.se.by.strata <-}\StringTok{ }\NormalTok{black.se.by.strata }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(strata.prop.sq}\OperatorTok{*}\NormalTok{(}\DecValTok{1}\OperatorTok{-}\NormalTok{n}\OperatorTok{/}\NormalTok{nh)}\OperatorTok{*}\NormalTok{var.by.strata)}
\NormalTok{black.str.se <-}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(}\KeywordTok{sum}\NormalTok{(black.se.by.strata}\OperatorTok{$}\StringTok{`}\DataTypeTok{strata.prop.sq * (1 - n/nh) * var.by.strata}\StringTok{`}\NormalTok{))}

\CommentTok{# Their difference}

\NormalTok{diff.p <-}\StringTok{ }\NormalTok{white.p.str.est }\OperatorTok{-}\StringTok{ }\NormalTok{black.p.str.est}
\NormalTok{pooled.se <-}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(white.str.se}\OperatorTok{^}\DecValTok{2} \OperatorTok{+}\StringTok{ }\NormalTok{black.str.se}\OperatorTok{^}\DecValTok{2}\NormalTok{)}
\NormalTok{(diff.p) }\OperatorTok{+}\StringTok{ }\NormalTok{z}\FloatTok{.95} \OperatorTok{*}\StringTok{ }\NormalTok{pooled.se }\OperatorTok{*}\StringTok{ }\KeywordTok{c}\NormalTok{(}\OperatorTok{-}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Guess the most conservative variance}
\CommentTok{# Find minimum domain sample size for desired CI width}
\NormalTok{var.guess <-}\StringTok{ }\FloatTok{0.25}
\NormalTok{ci.width <-}\StringTok{ }\FloatTok{0.2}
\NormalTok{n0 <-}\StringTok{ }\NormalTok{z}\FloatTok{.95}\OperatorTok{^}\DecValTok{2} \OperatorTok{*}\StringTok{ }\NormalTok{var.guess }\OperatorTok{/}\StringTok{ }\NormalTok{ci.width}\OperatorTok{^}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{openings.df.s1 <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\KeywordTok{table}\NormalTok{(white.str.sample}\OperatorTok{$}\NormalTok{opening_name))}
\NormalTok{openings.df.s2 <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\KeywordTok{table}\NormalTok{(black.str.sample}\OperatorTok{$}\NormalTok{opening_name))}
\KeywordTok{names}\NormalTok{(openings.df.s1) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"name"}\NormalTok{, }\StringTok{"frequency"}\NormalTok{)}
\KeywordTok{names}\NormalTok{(openings.df.s2) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"name"}\NormalTok{, }\StringTok{"frequency"}\NormalTok{)}

\CommentTok{# Include openings with sample size large enough for usable CI}
\NormalTok{openings.freq.s1 <-}\StringTok{ }\NormalTok{openings.df.s1[openings.df.s1}\OperatorTok{$}\NormalTok{frequency }\OperatorTok{>}\StringTok{ }\DecValTok{15}\NormalTok{,]}
\NormalTok{openings.freq.s2 <-}\StringTok{ }\NormalTok{openings.df.s2[openings.df.s2}\OperatorTok{$}\NormalTok{frequency }\OperatorTok{>}\StringTok{ }\DecValTok{15}\NormalTok{,]}

\NormalTok{openings.df.p <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\KeywordTok{table}\NormalTok{(df}\OperatorTok{$}\NormalTok{opening_name))}
\KeywordTok{names}\NormalTok{(openings.df.p) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"name"}\NormalTok{, }\StringTok{"frequency"}\NormalTok{)}

\CommentTok{# Include openings with sample sizes yielding the desired CI width}
\NormalTok{domain.sizes.s1 <-}\StringTok{ }\KeywordTok{c}\NormalTok{()}
\NormalTok{domain.sizes.s2 <-}\StringTok{ }\KeywordTok{c}\NormalTok{()}

\ControlFlowTok{for}\NormalTok{ (name }\ControlFlowTok{in}\NormalTok{ openings.freq.s1}\OperatorTok{$}\NormalTok{name) \{}
\NormalTok{  size <-}\StringTok{ }\NormalTok{n0 }\OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{+}\StringTok{ }\NormalTok{n0 }\OperatorTok{/}\StringTok{ }\NormalTok{openings.df.p[openings.df.p}\OperatorTok{$}\NormalTok{name }\OperatorTok{==}\StringTok{ }\NormalTok{name,]}\OperatorTok{$}\NormalTok{frequency)}
\NormalTok{  domain.sizes.s1 <-}\StringTok{ }\KeywordTok{c}\NormalTok{(domain.sizes.s1, size)}
\NormalTok{\}}

\ControlFlowTok{for}\NormalTok{ (name }\ControlFlowTok{in}\NormalTok{ openings.freq.s2}\OperatorTok{$}\NormalTok{name) \{}
\NormalTok{  size <-}\StringTok{ }\NormalTok{n0 }\OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{+}\StringTok{ }\NormalTok{n0 }\OperatorTok{/}\StringTok{ }\NormalTok{openings.df.p[openings.df.p}\OperatorTok{$}\NormalTok{name }\OperatorTok{==}\StringTok{ }\NormalTok{name,]}\OperatorTok{$}\NormalTok{frequency)}
\NormalTok{  domain.sizes.s2 <-}\StringTok{ }\KeywordTok{c}\NormalTok{(domain.sizes.s2, size)}
\NormalTok{\}}

\NormalTok{openings.valid.s1 <-}\StringTok{ }
\StringTok{  }\NormalTok{openings.freq.s1[openings.freq.s1}\OperatorTok{$}\NormalTok{frequency }\OperatorTok{>}\StringTok{ }\NormalTok{domain.sizes.s1,]}
\NormalTok{openings.valid.s2 <-}\StringTok{ }
\StringTok{  }\NormalTok{openings.freq.s2[openings.freq.s2}\OperatorTok{$}\NormalTok{frequency }\OperatorTok{>}\StringTok{ }\NormalTok{domain.sizes.s2,]}

\NormalTok{openings.valid.str.sample <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(openings.valid.s1, }
\NormalTok{                                   openings.valid.s2, }\DataTypeTok{by =} \StringTok{"name"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Guess the most conservative variance}
\CommentTok{# Find minimum domain sample size for desired CI width}
\NormalTok{var.guess <-}\StringTok{ }\FloatTok{0.25}
\NormalTok{ci.width <-}\StringTok{ }\FloatTok{0.2}
\NormalTok{n0 <-}\StringTok{ }\NormalTok{z}\FloatTok{.95}\OperatorTok{^}\DecValTok{2} \OperatorTok{*}\StringTok{ }\NormalTok{var.guess }\OperatorTok{/}\StringTok{ }\NormalTok{ci.width}\OperatorTok{^}\DecValTok{2}
\NormalTok{openings.df.s1 <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\KeywordTok{table}\NormalTok{(srs.sample.s1}\OperatorTok{$}\NormalTok{opening_name))}
\NormalTok{openings.df.s2 <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\KeywordTok{table}\NormalTok{(srs.sample.s2}\OperatorTok{$}\NormalTok{opening_name))}
\KeywordTok{names}\NormalTok{(openings.df.s1) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"name"}\NormalTok{, }\StringTok{"frequency"}\NormalTok{)}
\KeywordTok{names}\NormalTok{(openings.df.s2) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"name"}\NormalTok{, }\StringTok{"frequency"}\NormalTok{)}

\CommentTok{# Include openings with sample size large enough for usable CI}
\NormalTok{openings.freq.s1 <-}\StringTok{ }\NormalTok{openings.df.s1[openings.df.s1}\OperatorTok{$}\NormalTok{frequency }\OperatorTok{>}\StringTok{ }\DecValTok{15}\NormalTok{,]}
\NormalTok{openings.freq.s2 <-}\StringTok{ }\NormalTok{openings.df.s2[openings.df.s2}\OperatorTok{$}\NormalTok{frequency }\OperatorTok{>}\StringTok{ }\DecValTok{15}\NormalTok{,]}

\NormalTok{openings.df.p <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\KeywordTok{table}\NormalTok{(df}\OperatorTok{$}\NormalTok{opening_name))}
\KeywordTok{names}\NormalTok{(openings.df.p) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"name"}\NormalTok{, }\StringTok{"frequency"}\NormalTok{)}

\CommentTok{# Include openings with sample sizes yielding the desired CI width}
\NormalTok{domain.sizes.s1 <-}\StringTok{ }\KeywordTok{c}\NormalTok{()}
\NormalTok{domain.sizes.s2 <-}\StringTok{ }\KeywordTok{c}\NormalTok{()}

\ControlFlowTok{for}\NormalTok{ (name }\ControlFlowTok{in}\NormalTok{ openings.freq.s1}\OperatorTok{$}\NormalTok{name) \{}
\NormalTok{  domain.sizes.s1 <-}\StringTok{ }\KeywordTok{c}\NormalTok{(domain.sizes.s1, n0 }\OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{+}\StringTok{ }\NormalTok{n0 }\OperatorTok{/}\StringTok{ }\NormalTok{openings.df.p[openings.df.p}\OperatorTok{$}\NormalTok{name }\OperatorTok{==}\StringTok{ }\NormalTok{name,]}\OperatorTok{$}\NormalTok{frequency))}
\NormalTok{\}}

\ControlFlowTok{for}\NormalTok{ (name }\ControlFlowTok{in}\NormalTok{ openings.freq.s2}\OperatorTok{$}\NormalTok{name) \{}
\NormalTok{  domain.sizes.s2 <-}\StringTok{ }\KeywordTok{c}\NormalTok{(domain.sizes.s2, n0 }\OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{+}\StringTok{ }\NormalTok{n0 }\OperatorTok{/}\StringTok{ }\NormalTok{openings.df.p[openings.df.p}\OperatorTok{$}\NormalTok{name }\OperatorTok{==}\StringTok{ }\NormalTok{name,]}\OperatorTok{$}\NormalTok{frequency))}
\NormalTok{\}}

\NormalTok{openings.valid.s1 <-}\StringTok{ }\NormalTok{openings.freq.s1[openings.freq.s1}\OperatorTok{$}\NormalTok{frequency }\OperatorTok{>}\StringTok{ }\NormalTok{domain.sizes.s1,]}
\NormalTok{openings.valid.s2 <-}\StringTok{ }\NormalTok{openings.freq.s2[openings.freq.s2}\OperatorTok{$}\NormalTok{frequency }\OperatorTok{>}\StringTok{ }\NormalTok{domain.sizes.s2,]}

\NormalTok{openings.valid.srs.sample <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(openings.valid.s1, openings.valid.s2, }\DataTypeTok{by =} \StringTok{"name"}\NormalTok{)}

\NormalTok{estimates <-}\StringTok{ }\KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(openings.valid.srs.sample))}
\NormalTok{diff.ses <-}\StringTok{ }\KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(openings.valid.srs.sample))}
\NormalTok{intervals <-}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(openings.valid.srs.sample), }\DecValTok{2}\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(openings.valid.srs.sample)) \{}
  \CommentTok{# Find estimate and CI for difference in win rate for white/black}
  \CommentTok{# for one opening}
\NormalTok{  domain.name <-}\StringTok{ }\NormalTok{openings.valid.srs.sample[i, }\DecValTok{1}\NormalTok{]}
\NormalTok{  domain.s1 <-}\StringTok{ }\NormalTok{srs.sample.s1[srs.sample.s1}\OperatorTok{$}\NormalTok{opening_name }\OperatorTok{==}\StringTok{ }\NormalTok{domain.name,]}
\NormalTok{  domain.s2 <-}\StringTok{ }\NormalTok{srs.sample.s2[srs.sample.s2}\OperatorTok{$}\NormalTok{opening_name }\OperatorTok{==}\StringTok{ }\NormalTok{domain.name,]}
  
\NormalTok{  n.d}\FloatTok{.1}\NormalTok{ <-}\StringTok{ }\NormalTok{openings.valid.srs.sample[i, }\DecValTok{2}\NormalTok{]}
\NormalTok{  n.d}\FloatTok{.2}\NormalTok{ <-}\StringTok{ }\NormalTok{openings.valid.srs.sample[i, }\DecValTok{3}\NormalTok{]}

\NormalTok{  domain.p <-}\StringTok{ }\NormalTok{df[df}\OperatorTok{$}\NormalTok{opening_name }\OperatorTok{==}\StringTok{ }\NormalTok{domain.name,]}
\NormalTok{  N.d <-}\StringTok{ }\KeywordTok{nrow}\NormalTok{(domain.p)}
  
\NormalTok{  white.win.count <-}\StringTok{ }\KeywordTok{nrow}\NormalTok{(domain.s1[domain.s1}\OperatorTok{$}\NormalTok{winner }\OperatorTok{==}\StringTok{ "white"}\NormalTok{,])}
\NormalTok{  black.win.count <-}\StringTok{ }\KeywordTok{nrow}\NormalTok{(domain.s2[domain.s2}\OperatorTok{$}\NormalTok{winner }\OperatorTok{==}\StringTok{ "black"}\NormalTok{,])}
  
  \CommentTok{# Vanilla estimates}
\NormalTok{  white.p <-}\StringTok{ }\NormalTok{white.win.count }\OperatorTok{/}\StringTok{ }\NormalTok{n.d}\FloatTok{.1}
\NormalTok{  black.p <-}\StringTok{ }\NormalTok{black.win.count }\OperatorTok{/}\StringTok{ }\NormalTok{n.d}\FloatTok{.2}
  
\NormalTok{  estimates[i] <-}\StringTok{ }\NormalTok{white.p }\OperatorTok{-}\StringTok{ }\NormalTok{black.p}
  \CommentTok{# Using pooled variance}
\NormalTok{  pooled.var <-}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(((n.d}\FloatTok{.1}\DecValTok{-1}\NormalTok{)}\OperatorTok{*}\KeywordTok{var.est}\NormalTok{(white.p) }\OperatorTok{+}\StringTok{ }\NormalTok{(n.d}\FloatTok{.2}\DecValTok{-1}\NormalTok{)}\OperatorTok{*}\KeywordTok{var.est}\NormalTok{(black.p))}\OperatorTok{/}\NormalTok{(n.d}\FloatTok{.1}\OperatorTok{+}\NormalTok{n.d}\FloatTok{.2}\DecValTok{-2}\NormalTok{))}
\NormalTok{  diff.ses[i] <-}\StringTok{   }\NormalTok{pooled.var }\OperatorTok{*}\StringTok{ }\KeywordTok{sqrt}\NormalTok{((}\DecValTok{1}\OperatorTok{-}\NormalTok{n.d}\FloatTok{.1}\OperatorTok{/}\NormalTok{N)}\OperatorTok{*}\DecValTok{1}\OperatorTok{/}\NormalTok{n.d}\FloatTok{.1} \OperatorTok{+}\StringTok{ }\NormalTok{(}\DecValTok{1}\OperatorTok{-}\NormalTok{n.d}\FloatTok{.2}\OperatorTok{/}\NormalTok{N)}\OperatorTok{*}\DecValTok{1}\OperatorTok{/}\NormalTok{n.d}\FloatTok{.2}\NormalTok{)}
\NormalTok{  intervals[i,] <-}\StringTok{ }\NormalTok{(white.p }\OperatorTok{-}\StringTok{ }\NormalTok{black.p) }\OperatorTok{+}\StringTok{ }\KeywordTok{qt}\NormalTok{(}\FloatTok{0.975}\NormalTok{, n.d}\FloatTok{.1}\OperatorTok{+}\NormalTok{n.d}\FloatTok{.2}\DecValTok{-2}\NormalTok{) }\OperatorTok{*}\StringTok{ }\NormalTok{diff.ses[i] }\OperatorTok{*}\StringTok{ }\KeywordTok{c}\NormalTok{(}\OperatorTok{-}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{\}}

\NormalTok{openings <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(openings.valid.srs.sample}\OperatorTok{$}\NormalTok{name, estimates, diff.ses, intervals)}
\KeywordTok{names}\NormalTok{(openings) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"opening name"}\NormalTok{, }\StringTok{"Diff. win rate"}\NormalTok{, }\StringTok{"SE"}\NormalTok{, }\StringTok{"95.CI.lower"}\NormalTok{, }\StringTok{"95.CI.upper"}\NormalTok{)}
\NormalTok{white.higher <-}\StringTok{ }\NormalTok{openings[openings}\OperatorTok{$}\StringTok{`}\DataTypeTok{95.CI.lower}\StringTok{`} \OperatorTok{>}\StringTok{ }\DecValTok{0}\NormalTok{,]}
\NormalTok{white.lower <-}\StringTok{ }\NormalTok{openings[openings}\OperatorTok{$}\StringTok{`}\DataTypeTok{95.CI.upper}\StringTok{`} \OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{,]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{openings.df.s1 <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\KeywordTok{table}\NormalTok{(white.str.sample}\OperatorTok{$}\NormalTok{opening_name))}
\NormalTok{openings.df.s2 <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\KeywordTok{table}\NormalTok{(black.str.sample}\OperatorTok{$}\NormalTok{opening_name))}
\KeywordTok{names}\NormalTok{(openings.df.s1) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"name"}\NormalTok{, }\StringTok{"frequency"}\NormalTok{)}
\KeywordTok{names}\NormalTok{(openings.df.s2) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"name"}\NormalTok{, }\StringTok{"frequency"}\NormalTok{)}

\CommentTok{# Include openings with sample size large enough for usable CI}
\NormalTok{openings.freq.s1 <-}\StringTok{ }\NormalTok{openings.df.s1[openings.df.s1}\OperatorTok{$}\NormalTok{frequency }\OperatorTok{>}\StringTok{ }\DecValTok{15}\NormalTok{,]}
\NormalTok{openings.freq.s2 <-}\StringTok{ }\NormalTok{openings.df.s2[openings.df.s2}\OperatorTok{$}\NormalTok{frequency }\OperatorTok{>}\StringTok{ }\DecValTok{15}\NormalTok{,]}

\NormalTok{openings.df.p <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\KeywordTok{table}\NormalTok{(df}\OperatorTok{$}\NormalTok{opening_name))}
\KeywordTok{names}\NormalTok{(openings.df.p) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"name"}\NormalTok{, }\StringTok{"frequency"}\NormalTok{)}

\CommentTok{# openings.size.p1 <- openings.df.p[openings.df.p$name %in% openings.freq.s1$name,]}
\CommentTok{# openings.size.p2 <- openings.df.p[openings.df.p$name %in% openings.freq.s2$name,]}

\CommentTok{# Include openings with sample sizes yielding the desired CI width}
\NormalTok{domain.sizes.s1 <-}\StringTok{ }\KeywordTok{c}\NormalTok{()}
\NormalTok{domain.sizes.s2 <-}\StringTok{ }\KeywordTok{c}\NormalTok{()}

\ControlFlowTok{for}\NormalTok{ (name }\ControlFlowTok{in}\NormalTok{ openings.freq.s1}\OperatorTok{$}\NormalTok{name) \{}
\NormalTok{  domain.sizes.s1 <-}\StringTok{ }\KeywordTok{c}\NormalTok{(domain.sizes.s1, n0 }\OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{+}\StringTok{ }\NormalTok{n0 }\OperatorTok{/}\StringTok{ }\NormalTok{openings.df.p[openings.df.p}\OperatorTok{$}\NormalTok{name }\OperatorTok{==}\StringTok{ }\NormalTok{name,]}\OperatorTok{$}\NormalTok{frequency))}
\NormalTok{\}}

\ControlFlowTok{for}\NormalTok{ (name }\ControlFlowTok{in}\NormalTok{ openings.freq.s2}\OperatorTok{$}\NormalTok{name) \{}
\NormalTok{  domain.sizes.s2 <-}\StringTok{ }\KeywordTok{c}\NormalTok{(domain.sizes.s2, n0 }\OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{+}\StringTok{ }\NormalTok{n0 }\OperatorTok{/}\StringTok{ }\NormalTok{openings.df.p[openings.df.p}\OperatorTok{$}\NormalTok{name }\OperatorTok{==}\StringTok{ }\NormalTok{name,]}\OperatorTok{$}\NormalTok{frequency))}
\NormalTok{\}}

\NormalTok{openings.valid.s1 <-}\StringTok{ }\NormalTok{openings.freq.s1[openings.freq.s1}\OperatorTok{$}\NormalTok{frequency }\OperatorTok{>}\StringTok{ }\NormalTok{domain.sizes.s1,]}
\NormalTok{openings.valid.s2 <-}\StringTok{ }\NormalTok{openings.freq.s2[openings.freq.s2}\OperatorTok{$}\NormalTok{frequency }\OperatorTok{>}\StringTok{ }\NormalTok{domain.sizes.s2,]}

\NormalTok{openings.valid.str.sample <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(openings.valid.s1, openings.valid.s2, }\DataTypeTok{by =} \StringTok{"name"}\NormalTok{)}

\NormalTok{estimates <-}\StringTok{ }\KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(openings.valid.str.sample))}
\NormalTok{diff.ses <-}\StringTok{ }\KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(openings.valid.str.sample))}
\NormalTok{intervals <-}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(openings.valid.str.sample), }\DecValTok{2}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(openings.valid.str.sample)) \{}
  \CommentTok{# Find estimate and CI for difference in win rate for white/black}
  \CommentTok{# for one domain}
\NormalTok{  domain.name <-}\StringTok{ }\NormalTok{openings.valid.str.sample[i, }\DecValTok{1}\NormalTok{]}
\NormalTok{  domain.s1 <-}\StringTok{ }\NormalTok{white.str.sample[white.str.sample}\OperatorTok{$}\NormalTok{opening_name }\OperatorTok{==}\StringTok{ }\NormalTok{domain.name,]}
\NormalTok{  domain.s2 <-}\StringTok{ }\NormalTok{black.str.sample[black.str.sample}\OperatorTok{$}\NormalTok{opening_name }\OperatorTok{==}\StringTok{ }\NormalTok{domain.name,]}
\NormalTok{  domain.p <-}\StringTok{ }\NormalTok{df[df}\OperatorTok{$}\NormalTok{opening_name }\OperatorTok{==}\StringTok{ }\NormalTok{domain.name,]}
  
\NormalTok{  n.d.s1 <-}\StringTok{ }\NormalTok{openings.valid.str.sample[i, }\DecValTok{2}\NormalTok{]}
\NormalTok{  n.d.s2 <-}\StringTok{ }\NormalTok{openings.valid.str.sample[i, }\DecValTok{3}\NormalTok{]}

\NormalTok{  N.d <-}\StringTok{ }\KeywordTok{nrow}\NormalTok{(domain.p)}
\NormalTok{  nh.d1 <-}\StringTok{ }\NormalTok{domain.s1 }\OperatorTok{%>%}\StringTok{ }\KeywordTok{count}\NormalTok{(elo_range, }\DataTypeTok{.drop=}\OtherTok{FALSE}\NormalTok{)}
\NormalTok{  nh.d2 <-}\StringTok{ }\NormalTok{domain.s2 }\OperatorTok{%>%}\StringTok{ }\KeywordTok{count}\NormalTok{(elo_range, }\DataTypeTok{.drop=}\OtherTok{FALSE}\NormalTok{)}
\NormalTok{  Nh.d <-}\StringTok{ }\NormalTok{domain.p }\OperatorTok{%>%}\StringTok{ }\KeywordTok{count}\NormalTok{(elo_range, }\DataTypeTok{.drop=}\OtherTok{FALSE}\NormalTok{)}
\NormalTok{  strata.size.prop <-}\StringTok{ }\NormalTok{Nh.d[}\DecValTok{2}\NormalTok{]}\OperatorTok{/}\NormalTok{N.d}
  
  \CommentTok{# Calculate white's win proportion by each strata}
\NormalTok{  white.win.prop <-}\StringTok{ }\NormalTok{domain.s1 }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{count}\NormalTok{(winner, }\DataTypeTok{.drop=}\OtherTok{FALSE}\NormalTok{) }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{group_by}\NormalTok{(elo_range) }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{win.prop =}\NormalTok{ n }\OperatorTok{/}\StringTok{ }\KeywordTok{sum}\NormalTok{(n))}
  
  \CommentTok{# The estimated aggregated win proportion for white}
\NormalTok{  white.prop <-}\StringTok{ }\NormalTok{white.win.prop[white.win.prop}\OperatorTok{$}\NormalTok{winner }\OperatorTok{==}\StringTok{ "white"}\NormalTok{, ] }
\NormalTok{  white.prop[}\KeywordTok{is.na}\NormalTok{(white.prop)] <-}\StringTok{ }\DecValTok{0}
\NormalTok{  white.p.str.est <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(white.prop}\OperatorTok{$}\NormalTok{win.prop }\OperatorTok{*}\StringTok{ }\NormalTok{strata.size.prop)}
  
  \CommentTok{# The estimated aggregated variance of win proportion for white}
\NormalTok{  white.se.by.strata <-}\StringTok{ }\KeywordTok{bind_cols}\NormalTok{(white.prop, }\DataTypeTok{nh =}\NormalTok{ nh.d1}\OperatorTok{$}\NormalTok{n)}
\NormalTok{  white.se.by.strata <-}\StringTok{ }\NormalTok{white.se.by.strata }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{var.by.strata =}\NormalTok{ win.prop }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1}\OperatorTok{-}\NormalTok{win.prop)}\OperatorTok{/}\NormalTok{nh)}
\NormalTok{  white.se.by.strata <-}\StringTok{ }\KeywordTok{bind_cols}\NormalTok{(white.se.by.strata, }\DataTypeTok{Nh =}\NormalTok{ Nh.d}\OperatorTok{$}\NormalTok{n)}
\NormalTok{  white.se.by.strata <-}\StringTok{ }\KeywordTok{bind_cols}\NormalTok{(white.se.by.strata, }\DataTypeTok{strata.prop.sq =}\NormalTok{ strata.size.prop}\OperatorTok{$}\NormalTok{n}\OperatorTok{^}\DecValTok{2}\NormalTok{)}
\NormalTok{  white.se.by.strata <-}\StringTok{ }\NormalTok{white.se.by.strata }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(strata.prop.sq}\OperatorTok{*}\NormalTok{(}\DecValTok{1}\OperatorTok{-}\NormalTok{nh}\OperatorTok{/}\NormalTok{Nh)}\OperatorTok{*}\NormalTok{var.by.strata)}
\NormalTok{  white.se.by.strata[}\KeywordTok{is.na}\NormalTok{(white.se.by.strata)] <-}\StringTok{ }\DecValTok{0}
\NormalTok{  white.str.se <-}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(}\KeywordTok{sum}\NormalTok{(white.se.by.strata}\OperatorTok{$}\StringTok{`}\DataTypeTok{strata.prop.sq * (1 - nh/Nh) * var.by.strata}\StringTok{`}\NormalTok{))}
  
  \CommentTok{# Calculate black's win proportion by each strata}
\NormalTok{  black.win.prop <-}\StringTok{ }\NormalTok{domain.s2 }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{count}\NormalTok{(winner, }\DataTypeTok{.drop=}\OtherTok{FALSE}\NormalTok{) }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{group_by}\NormalTok{(elo_range) }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{win.prop =}\NormalTok{ n }\OperatorTok{/}\StringTok{ }\KeywordTok{sum}\NormalTok{(n))}
  
  \CommentTok{# The estimated aggregated win proportion for white}
\NormalTok{  black.prop <-}\StringTok{ }\NormalTok{black.win.prop[black.win.prop}\OperatorTok{$}\NormalTok{winner }\OperatorTok{==}\StringTok{ "black"}\NormalTok{, ] }
\NormalTok{  black.prop[}\KeywordTok{is.na}\NormalTok{(black.prop)] <-}\StringTok{ }\DecValTok{0}
\NormalTok{  black.p.str.est <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(black.prop}\OperatorTok{$}\NormalTok{win.prop }\OperatorTok{*}\StringTok{ }\NormalTok{strata.size.prop)}
  
  \CommentTok{# The estimated aggregated variance of win proportion for black}
\NormalTok{  black.se.by.strata <-}\StringTok{ }\KeywordTok{bind_cols}\NormalTok{(black.prop, }\DataTypeTok{nh =}\NormalTok{ nh.d2}\OperatorTok{$}\NormalTok{n)}
\NormalTok{  black.se.by.strata <-}\StringTok{ }\NormalTok{black.se.by.strata }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{var.by.strata =}\NormalTok{ win.prop }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1}\OperatorTok{-}\NormalTok{win.prop)}\OperatorTok{/}\NormalTok{nh)}
\NormalTok{  black.se.by.strata <-}\StringTok{ }\KeywordTok{bind_cols}\NormalTok{(black.se.by.strata, }\DataTypeTok{Nh =}\NormalTok{ Nh.d}\OperatorTok{$}\NormalTok{n)}
\NormalTok{  black.se.by.strata <-}\StringTok{ }\KeywordTok{bind_cols}\NormalTok{(black.se.by.strata, }\DataTypeTok{strata.prop.sq =}\NormalTok{ strata.size.prop}\OperatorTok{$}\NormalTok{n}\OperatorTok{^}\DecValTok{2}\NormalTok{)}
\NormalTok{  black.se.by.strata <-}\StringTok{ }\NormalTok{black.se.by.strata }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(strata.prop.sq}\OperatorTok{*}\NormalTok{(}\DecValTok{1}\OperatorTok{-}\NormalTok{nh}\OperatorTok{/}\NormalTok{Nh)}\OperatorTok{*}\NormalTok{var.by.strata)}
\NormalTok{  black.se.by.strata[}\KeywordTok{is.na}\NormalTok{(black.se.by.strata)] <-}\StringTok{ }\DecValTok{0}
\NormalTok{  black.str.se <-}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(}\KeywordTok{sum}\NormalTok{(black.se.by.strata}\OperatorTok{$}\StringTok{`}\DataTypeTok{strata.prop.sq * (1 - nh/Nh) * var.by.strata}\StringTok{`}\NormalTok{))}
  

  \CommentTok{# Their difference}
\NormalTok{  estimates[i] <-}\StringTok{ }\NormalTok{white.p.str.est }\OperatorTok{-}\StringTok{ }\NormalTok{black.p.str.est}
  \CommentTok{# Using pooled variance}
\NormalTok{  diff.ses[i] <-}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(white.str.se}\OperatorTok{^}\DecValTok{2} \OperatorTok{+}\StringTok{ }\NormalTok{black.str.se}\OperatorTok{^}\DecValTok{2}\NormalTok{)}
\NormalTok{  intervals[i,] <-}\StringTok{ }\NormalTok{(white.p.str.est }\OperatorTok{-}\StringTok{ }\NormalTok{black.p.str.est) }\OperatorTok{+}\StringTok{ }\KeywordTok{qt}\NormalTok{(}\FloatTok{0.975}\NormalTok{, n.d.s1}\OperatorTok{+}\NormalTok{n.d.s2}\OperatorTok{-}\StringTok{ }\DecValTok{2}\NormalTok{) }\OperatorTok{*}\StringTok{ }\NormalTok{diff.ses[i] }\OperatorTok{*}\StringTok{ }\KeywordTok{c}\NormalTok{(}\OperatorTok{-}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{\}}



\NormalTok{openings <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(openings.valid.str.sample}\OperatorTok{$}\NormalTok{name, estimates, diff.ses, intervals)}
\KeywordTok{names}\NormalTok{(openings) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"opening name"}\NormalTok{, }\StringTok{"Diff. win rate"}\NormalTok{, }\StringTok{"SE"}\NormalTok{, }\StringTok{"95.CI.lower"}\NormalTok{, }\StringTok{"95.CI.upper"}\NormalTok{)}
\NormalTok{white.higher <-}\StringTok{ }\NormalTok{openings[openings}\OperatorTok{$}\StringTok{`}\DataTypeTok{95.CI.lower}\StringTok{`} \OperatorTok{>}\StringTok{ }\DecValTok{0}\NormalTok{,]}
\NormalTok{white.lower <-}\StringTok{ }\NormalTok{openings[openings}\OperatorTok{$}\StringTok{`}\DataTypeTok{95.CI.upper}\StringTok{`} \OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{,]}
\NormalTok{openings}
\end{Highlighting}
\end{Shaded}





\newpage
\singlespacing 
\end{document}
